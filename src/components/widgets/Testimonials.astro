---
import testimonials from '../../../public/testimonials.json';
import { Icon } from 'astro-icon/components';
import WidgetWrapper from '../ui/WidgetWrapper.astro';
---

<style>
  .carousel {
    position: relative;
    overflow: hidden;
    width: 100%;
    margin: auto;
    align-items: center;
  }

  .carousel-track {
    display: flex;
    transition: transform 0.5s ease-in-out;
    will-change: transform;
  }

  .carousel-slide {
    display: grid;
    align-items: center;
    min-width: 80%;
    box-sizing: border-box;
    padding: 1rem 6rem;
    color: var(--aw-color-text-default);
    text-align: center;
    flex: 0 0 100%;
    gap: 0.5rem;
  }

  .carousel-button {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    border: none;
    color: var(--aw-color-text-default);
    padding: 0.5rem;
    cursor: pointer;
    z-index: 10;
    font-size: 1.5rem;
  }
  .carousel-button.prev {
    left: 10px;
  }

  .carousel-button.next {
    right: 10px;
  }

  .stars {
    display: flex;
    justify-content: center;
    margin-top: 0.5rem;
  }

  .star {
    font-size: 1.5rem;
    color: var(--aw-color-yellow);
    margin: 0 0.1rem;
  }

  @media (max-width: 768px) {
    .carousel-slide {
      font-size: 0.9rem;
      padding: 1rem;
      gap: 0.25rem;
    }
  }

  /* Dark Mode Styles */
  .dark-mode .carousel-slide {
    background: var(--aw-color-bg-page);
    color: var(--aw-color-text-default);
  }

  .dark-mode .carousel-button {
    background: var(--aw-color-bg-page);
    color: var(--aw-color-text-default);
  }

  .dark-mode .star {
    color: var(--aw-color-text-default);
  }
</style>

<WidgetWrapper id="testimonials">
  <!-- Json file lives on the cloud host only and is updated via an api call -->
  <div class="carousel" aria-roledescription="carousel">
    <div class="carousel-track" id="carousel-track">
      {testimonials.map((testimonial, index) => (
        <div class="carousel-slide" role="group" aria-roledescription="slide" aria-label={`Slide ${index + 1} of ${testimonials.length}`} key={index}>
          <strong>{testimonial.title}</strong>
          <p>{testimonial.testimonial}</p>
          <p>- {testimonial.name}</p>
          <div class="stars">
            {Array.from({ length: 5 }, (_, i) => (
              <Icon
                key={i}
                name={i < testimonial.rating ? 'mdi:star' : 'mdi:star-outline'}
                class="star"
              />
            ))}
          </div>
        </div>
      ))}
    </div>
    <button class="carousel-button prev" id="prevButton" aria-label="Previous slide">&#10094;</button>
    <button class="carousel-button next" id="nextButton" aria-label="Next slide">&#10095;</button>
  </div>
</WidgetWrapper>

<script is:inline>
  (function() {
    let track = document.getElementById('carousel-track');
    let slides = Array.from(track.children);
    let nextButton = document.getElementById('nextButton');
    let prevButton = document.getElementById('prevButton');
  
    let currentIndex = 0;
  
    const moveToSlide = (index) => {
      let amountToMove = -index * track.clientWidth;
      track.style.transform = `translateX(${amountToMove}px)`;
    };
  
    const autoScroll = () => {
      currentIndex = (currentIndex + 1) % slides.length;
      moveToSlide(currentIndex);
    };
  
    const nextButtonClickHandler = () => {
      currentIndex = (currentIndex + 1) % slides.length;
      moveToSlide(currentIndex);
    };
  
    const prevButtonClickHandler = () => {
      currentIndex = (currentIndex - 1 + slides.length) % slides.length;
      moveToSlide(currentIndex);
    };
  
    nextButton.addEventListener('click', nextButtonClickHandler);
    prevButton.addEventListener('click', prevButtonClickHandler);
  
    let autoScrollInterval = setInterval(autoScroll, 5000);
  
    track.addEventListener('mouseenter', () => {
      clearInterval(autoScrollInterval);
    });
  
    track.addEventListener('mouseleave', () => {
      autoScrollInterval = setInterval(autoScroll, 5000);
    });
  
    window.addEventListener('resize', () => {
      moveToSlide(currentIndex);
    });

    // Cleanup function to remove event listeners
    window.addEventListener('beforeunload', () => {
      nextButton.removeEventListener('click', nextButtonClickHandler);
      prevButton.removeEventListener('click', prevButtonClickHandler);
      clearInterval(autoScrollInterval);
    });
  })();
</script>