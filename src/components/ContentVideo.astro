---
/**
 * ContentVideo Component
 *
 * @description Displays content alongside an embedded video (YouTube or Vimeo), with option to reverse video position.
 */
interface Props {
  /** A YouTube URL (share link, watch/shorts link, embed) OR a local video file path under /public. */
  videoUrl: string
  /** Place video on the right instead of the left. */
  reverseVideo?: boolean
  /** Optional title for iframe or video (accessibility). */
  title?: string
  /** Optional aspect ratio (e.g. "16/9", "4/3"). Defaults to 16/9. */
  aspect?: string
  /** Poster image for local video (path under /public). */
  poster?: string
  /** Autoplay local video (muted required if true). */
  autoplay?: boolean
  /** Loop local video. */
  loop?: boolean
  /** Muted local video (needed for autoplay). */
  muted?: boolean
  /** Show native controls for local video. */
  controls?: boolean
  /** Optional caption to display below the video. */
  caption?: string
}

const {
  videoUrl,
  reverseVideo = false,
  title = 'Embedded video',
  aspect = '16/9',
  poster,
  autoplay = false,
  loop = false,
  muted = false,
  controls = true,
  caption,
}: Props = Astro.props

function getYouTubeEmbed(raw: string): string | null {
  try {
    const url = new URL(raw, 'https://dummy.base') // permit relative? ensures URL parser
    const host = url.hostname.replace(/^www\./, '')
    if (!/^youtube\.com$|^youtu\.be$/.test(host)) return null

    let videoId = ''
    let params = ''

    if (host === 'youtu.be') {
      videoId = url.pathname.slice(1)
    } else if (url.pathname.startsWith('/watch')) {
      videoId = url.searchParams.get('v') || ''
    } else if (url.pathname.startsWith('/shorts/')) {
      videoId = url.pathname.split('/')[2] || ''
    } else if (url.pathname.startsWith('/embed/')) {
      videoId = url.pathname.split('/')[2] || ''
    }

    const start = url.searchParams.get('t') || url.searchParams.get('start')
    if (start) {
      const seconds = start.endsWith('s')
        ? parseInt(start.slice(0, -1))
        : /\d+[hms]/.test(start)
          ? convertToSeconds(start)
          : parseInt(start)
      if (!isNaN(seconds)) {
        params += (params ? '&' : '') + `start=${seconds}`
      }
    }
    const base = 'https://www.youtube.com/embed/' + videoId
    return params ? `${base}?${params}` : base
  } catch {
    return null
  }
}

function convertToSeconds(spec: string): number {
  // Support formats like 1h2m3s, 2m10s, 90s
  let total = 0
  const regex = /(\d+)(h|m|s)/g
  let match
  while ((match = regex.exec(spec))) {
    const val = parseInt(match[1])
    switch (match[2]) {
      case 'h':
        total += val * 3600
        break
      case 'm':
        total += val * 60
        break
      case 's':
        total += val
        break
    }
  }
  return total
}

const isLocal = !/^https?:\/\//.test(videoUrl)
const youTubeEmbed = !isLocal ? getYouTubeEmbed(videoUrl) : null
const embedSrc = youTubeEmbed || ''
---

<section>
  <div class="container">
    <div class="grid grid-cols-1 gap-24 md:grid-cols-2">
      {
        !reverseVideo ? (
          <figure class="aspect-video overflow-hidden rounded-lg" style={`aspect-ratio:${aspect}`}>
            {isLocal ? (
              <video
                class="h-full w-full object-cover"
                title={title}
                poster={poster}
                autoplay={autoplay}
                loop={loop}
                muted={muted || autoplay}
                controls={controls}
              >
                <source src={videoUrl} />
                Your browser does not support the video tag.
              </video>
            ) : (
              <iframe
                src={embedSrc}
                title={title}
                loading="lazy"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen
                class="h-full w-full"
              />
            )}
            {caption ? <figcaption class="mt-2 text-center text-base text-gray-500">{caption}</figcaption> : ''}
          </figure>
        ) : (
          ''
        )
      }
      <div class="space-content flex flex-col justify-center">
        <slot />
      </div>
      {
        reverseVideo ? (
          <figure class="aspect-video overflow-hidden rounded-lg" style={`aspect-ratio:${aspect}`}>
            {isLocal ? (
              <video
                class="h-full w-full object-cover"
                title={title}
                poster={poster}
                autoplay={autoplay}
                loop={loop}
                muted={muted || autoplay}
                controls={controls}
              >
                <source src={videoUrl} />
                Your browser does not support the video tag.
              </video>
            ) : (
              <iframe
                src={embedSrc}
                title={title}
                loading="lazy"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
                allowfullscreen
                class="h-full w-full"
              />
            )}
            {caption ? <figcaption class="mt-2 text-center text-base text-gray-500">{caption}</figcaption> : ''}
          </figure>
        ) : (
          ''
        )
      }
    </div>
  </div>
</section>