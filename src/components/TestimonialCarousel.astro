---
import testimonials from '../../public/testimonials.json'
---

<style lang="scss" is:global>

  .carousel {
    position: relative;
    overflow: hidden;
    width: 100%;
    margin: auto;
    align-items: center;
    background-color: var(--background-color);
    border-radius: var(--radius-large);
  }

  .carousel-track {
    display: flex;
    transition: transform var(--animation-speed-slow) var(--cubic-bezier);
    will-change: transform;
  }

  .carousel-slide {
    display: grid;
    align-items: center;
    justify-items: center;
    min-width: 80%;
    box-sizing: border-box;
    padding: var(--gap-default) clamp(1rem, 6rem, 10vw);
    color: var(--foreground-color);
    text-align: center;
    flex: 0 0 100%;
    gap: 1rem;
  }



  .stars {
    display: flex;
    justify-content: center;
    gap: 0.25rem;
    margin-top: 0.5rem;
  }

  .star-icon {
    width: 1.5rem;
    height: 1.5rem;
    transition: color var(--animation-speed-fast);
  }

  .star-filled {
    fill: var(--link-color);
    stroke: var(--link-color);
  }

  .star-empty {
    fill: none;
    stroke: var(--border-color-subtle);
  }

  @media (max-width: 768px) {
    .carousel-slide {
      font-size: 0.9rem;
      padding: 1rem;
      gap: 0.5rem;
    }
  }

  /* Enhanced focus and hover states */
  .darkmode .star-filled {
    fill: var(--link-hover-color);
    stroke: var(--link-hover-color);
  }

  .darkmode .star-empty {
    stroke: var(--border-color-subtle);
  }
</style>

<!-- Json file lives on the cloud host only and is updated via an api call -->
<div class="carousel" aria-roledescription="carousel">
  <div class="carousel-track" id="carousel-track">
    {testimonials.map((testimonial, index) => (
      <div class="carousel-slide" role="group" aria-roledescription="slide" aria-label={`Slide ${index + 1} of ${testimonials.length}`}>
        <h3><strong>{testimonial.title}</strong></h3>
        <blockquote>{testimonial.testimonial}</blockquote>
        <cite>- {testimonial.name}</cite>
        <div class="stars" role="img" aria-label={`${testimonial.rating} out of 5 stars`}>
          {Array.from({ length: 5 }, (_, i) => (
            <svg
              class={`star-icon ${i < testimonial.rating ? 'star-filled' : 'star-empty'}`}
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z"/>
            </svg>
          ))}
        </div>
      </div>
    ))}
</div>

<script is:inline>
  (function() {
    let track = document.getElementById('carousel-track');
    let slides = Array.from(track.children);
    let carousel = track.parentElement;
    let currentIndex = 0;
    let autoScrollInterval;
    let isPaused = false;

    const moveToSlide = (index) => {
      let amountToMove = -index * track.clientWidth;
      track.style.transform = `translateX(${amountToMove}px)`;
    };

    const autoScroll = () => {
      if (!isPaused) {
        currentIndex = (currentIndex + 1) % slides.length;
        moveToSlide(currentIndex);
      }
    };

    const startAutoScroll = () => {
      autoScrollInterval = setInterval(autoScroll, 7000); // Slower 7 seconds
    };

    const stopAutoScroll = () => {
      clearInterval(autoScrollInterval);
    };

    // Pause on hover/focus
    carousel.addEventListener('mouseenter', () => {
      isPaused = true;
      stopAutoScroll();
    });

    carousel.addEventListener('mouseleave', () => {
      isPaused = false;
      startAutoScroll();
    });

    // Handle focus events for accessibility
    carousel.addEventListener('focusin', () => {
      isPaused = true;
      stopAutoScroll();
    });

    carousel.addEventListener('focusout', () => {
      isPaused = false;
      startAutoScroll();
    });

    // Handle resize
    window.addEventListener('resize', () => {
      moveToSlide(currentIndex);
    });

    // Start the carousel
    startAutoScroll();

    // Cleanup
    window.addEventListener('beforeunload', () => {
      stopAutoScroll();
    });
  })();
</script>